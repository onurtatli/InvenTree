{% extends "two_column.html" %}
{% load static %}
{% load inventree_extras %}
{% load status_codes %}
{% load i18n %}

{% block page_title %}
InvenTree | {% trans "Stock Item" %} - {{ item }}
{% endblock %}

{% block sidenav %}
<div id='stock-tree'></div>
{% endblock %}

{% block pre_content %}
{% include 'stock/loc_link.html' with location=item.location %}

{% if item.hasRequiredTests and not item.passedAllRequiredTests %}
<div class='alert alert-block alert-danger'>
    {% trans "This stock item has not passed all required tests" %}
</div>
{% endif %}

{% for allocation in item.sales_order_allocations.all %}
<div class='alert alert-block alert-info'>
    {% trans "This stock item is allocated to Sales Order" %} <a href="{% url 'so-detail' allocation.line.order.id %}"><b>#{{ allocation.line.order.reference }}</b></a> ({% trans "Quantity" %}: {% decimal allocation.quantity %})
</div>
{% endfor %}

{% for allocation in item.allocations.all %}
<div class='alert alert-block alert-info'>
    {% trans "This stock item is allocated to Build" %} <a href="{% url 'build-detail' allocation.build.id %}"><b>#{{ allocation.build.id }}</b></a> ({% trans "Quantity" %}: {% decimal allocation.quantity %})
</div>
{% endfor %}

{% if item.serialized %}
<div class='alert alert-block alert-warning'>
    {% trans "This stock item is serialized - it has a unique serial number and the quantity cannot be adjusted." %}
</div>
{% elif item.child_count > 0 %}
<div class='alert alert-block alert-warning'>
    {% trans "This stock item cannot be deleted as it has child items" %}
</div>
{% elif item.delete_on_deplete and item.can_delete %}
<div class='alert alert-block alert-warning'>
    {% trans "This stock item will be automatically deleted when all stock is depleted." %}
</div>
{% endif %}

{% endblock %}

{% block thumbnail %}
<img class='part-thumb' {% if item.part.image %}src="{{ item.part.image.url }}"{% else %}src="{% static 'img/blank_image.png' %}"{% endif %}/>
{% endblock %}

{% block page_data %}
<h3>
    {% trans "Stock Item" %}
    {% stock_status_label item.status large=True %}
</h3>
<hr>
<h4>
{% if item.serialized %}
{{ item.part.full_name}} # {{ item.serial }}
{% else %}
{% decimal item.quantity %} &times {{ item.part.full_name }}
{% endif %}
</h4>

<div class='btn-group action-buttons'>
    {% include "qr_button.html" %}
    {% if item.in_stock %}
    {% if not item.serialized %}
    <button type='button' class='btn btn-default' id='stock-add' title='Add to stock'>
        <span class='fas fa-plus-circle icon-green'/>
    </button>
    <button type='button' class='btn btn-default' id='stock-remove' title='Take from stock'>
        <span class='fas fa-minus-circle icon-red''/>
    </button>
    <button type='button' class='btn btn-default' id='stock-count' title='Count stock'>
        <span class='fas fa-clipboard-list'/>
    </button>
    {% if item.part.trackable %}
    <button type='button' class='btn btn-default' id='stock-serialize' title='Serialize stock'>
        <span class='fas fa-hashtag'/>
    </button>
    {% endif %}
    {% endif %}
    <button type='button' class='btn btn-default' id='stock-move' title='Transfer stock'>
        <span class='fas fa-exchange-alt icon-blue'/>
    </button>
    <button type='button' class='btn btn-default' id='stock-duplicate' title='Duplicate stock item'>
        <span class='fas fa-copy'/>
    </button>
    {% endif %}
    {% if item.part.has_test_report_templates %}
    <button type='button' class='btn btn-default' id='stock-test-report' title='Generate test report'>
        <span class='fas fa-tasks'/>
    </button>
    {% endif %}
    <button type='button' class='btn btn-default' id='stock-edit' title='Edit stock item'>
        <span class='fas fa-edit icon-blue'/>
    </button>
    {% if item.can_delete %}
    <button type='button' class='btn btn-default' id='stock-delete' title='Edit stock item'>
        <span class='fas fa-trash-alt icon-red'/>
    </button>
    {% endif %}
</div>

{% endblock %}

{% block page_details %}
<h4>{% trans "Stock Item Details" %}</h4>
<table class="table table-striped">
    <col width='25'>
    <tr>
        <td><span class='fas fa-shapes'></span></td>
        <td>{% trans "Base Part" %}</td>
        <td>
            <a href="{% url 'part-stock' item.part.id %}">{{ item.part.full_name }}
        </td>
    </tr>
    {% if item.belongs_to %}
    <tr>
        <td><span class='fas fa-box'></span></td>
        <td>{% trans "Belongs To" %}</td>
        <td><a href="{% url 'stock-item-detail' item.belongs_to.id %}">{{ item.belongs_to }}</a></td>
    </tr>
    {% elif item.sales_order %}
    <tr>
        <td><span class='fas fa-user-tie'></span></td>
        <td>{% trans "Sales Order" %}</td>
        <td><a href="{% url 'so-detail' item.sales_order.id %}">{{ item.sales_order.reference }}</a> - <a href="{% url 'company-detail' item.sales_order.customer.id %}">{{ item.sales_order.customer.name }}</a></td>
    </tr>
    {% elif item.build_order %}
    <tr>
        <td><span class='fas fa-tools'></span></td>
        <td>{% trans "Build Order" %}</td>
        <td><a href="{% url 'build-detail' item.build_order.id %}">{{ item.build_order }}</a></td>
    </tr>
    {% elif item.location %}
    <tr>
        <td><span class='fas fa-map-marker-alt'></span></td>
        <td>{% trans "Location" %}</td>
        <td><a href="{% url 'stock-location-detail' item.location.id %}">{{ item.location.name }}</a></td>
    </tr>
    {% endif %}
    {% if item.uid %}
    <tr>
        <td><span class='fas fa-barcode'></span></td>
        <td>{% trans "Unique Identifier" %}</td>
        <td>{{ item.uid }}</td>
    </tr>
    {% endif %}
    {% if item.serialized %}
    <tr>
        <td><span class='fas fa-hashtag'></span></td>
        <td>{% trans "Serial Number" %}</td>
        <td>{{ item.serial }}</td>
    </tr>
    {% else %}
    <tr>
        <td></td>
        <td>{% trans "Quantity" %}</td>
        <td>{% decimal item.quantity %} {% if item.part.units %}{{ item.part.units }}{% endif %}</td>
    </tr>
    {% endif %}
    {% if item.batch %}
    <tr>
        <td></td>
        <td>{% trans "Batch" %}</td>
        <td>{{ item.batch }}</td>
    </tr>
    {% endif %}
    {% if item.build %}
    <tr>
        <td><span class='fas fa-tools'></span></td>
        <td>{% trans "Build" %}</td>
        <td><a href="{% url 'build-detail' item.build.id %}">{{ item.build }}</a></td>
    </tr>
    {% endif %}
    {% if item.purchase_order %}
    <tr>
        <td></td>
        <td>{% trans "Purchase Order" %}</td>
        <td><a href="{% url 'po-detail' item.purchase_order.id %}">{{ item.purchase_order }}</a></td>
    </tr>
    {% endif %}
    {% if item.parent %}
    <tr>
        <td><span class='fas fa-sitemap'></span></td>
        <td>{% trans "Parent Item" %}</td>
        <td><a href="{% url 'stock-item-detail' item.parent.id %}">{% trans "Stock Item" %} #{{ item.parent.id }}</a></td>
    </tr>
    {% endif %}
    {% if item.link %}
    <tr>
        <td><span class='fas fa-link'></span>
        <td>{% trans "External Link" %}</td>
        <td><a href="{{ item.link }}">{{ item.link }}</a></td>
    </tr>
    {% endif %}
    {% if item.supplier_part %}
    <tr>
        <td><span class='fas fa-industry'></span></td>
        <td>{% trans "Supplier" %}</td>
        <td><a href="{% url 'company-detail' item.supplier_part.supplier.id %}">{{ item.supplier_part.supplier.name }}</a></td>
    </tr>
    <tr>
        <td><span class='fas fa-shapes'></span></td>
        <td>{% trans "Supplier Part" %}</td>
        <td><a href="{% url 'supplier-part-detail' item.supplier_part.id %}">{{ item.supplier_part.SKU }}</a></td>
    </tr>
    {% endif %}
    <tr>
        <td><span class='fas fa-calendar-alt'></span></td>
        <td>{% trans "Last Updated" %}</td>
        <td>{{ item.updated }}</td>
    </tr>
    <tr>
        <td><span class='fas fa-calendar-alt'></span></td>
        <td>{% trans "Last Stocktake" %}</td>
        {% if item.stocktake_date %}
        <td>{{ item.stocktake_date }} <span class='badge'>{{ item.stocktake_user }}</span></td>
        {% else %}
        <td>{% trans "No stocktake performed" %}</td>
        {% endif %}
    </tr>
    <tr>
        <td><span class='fas fa-info'></span></td>
        <td>{% trans "Status" %}</td>
        <td>{% stock_status_label item.status %}</td>
    </tr>
    {% if item.hasRequiredTests %}
    <tr>
        <td><span class='fas fa-vial'></span></td>
        <td>{% trans "Tests" %}</td>
        <td>{{ item.requiredTestStatus.passed }} / {{ item.requiredTestStatus.total }}</td>
    </tr>
    {% endif %}
</table>
{% endblock %}

{% block js_ready %}

{{ block.super }}

loadTree("{% url 'api-stock-tree' %}",
        "#stock-tree",
        {
            name: 'stock',
        }
    );

    $("#toggle-stock-tree").click(function() {
        toggleSideNav("#sidenav");
        return false;
    })

    initSideNav();

$("#stock-serialize").click(function() {
    launchModalForm(
        "{% url 'stock-item-serialize' item.id %}",
        {
            reload: true,
        }
    );
});

{% if item.part.has_test_report_templates %}
$("#stock-test-report").click(function() {
    launchModalForm(
        "{% url 'stock-item-test-report-select' item.id %}",
        {
            follow: true,
        }
    );
});
{% endif %}

$("#stock-duplicate").click(function() {
    launchModalForm(
        "{% url 'stock-item-create' %}",
        {
            follow: true,
            data: {
                copy: {{ item.id }},
            },
        }
    );
});

$("#stock-edit").click(function () {
    launchModalForm(
        "{% url 'stock-item-edit' item.id %}",
        {
            reload: true,
            submit_text: "Save",
        }
    );
});

$("#show-qr-code").click(function() {
    launchModalForm("{% url 'stock-item-qr' item.id %}",
    {
        no_post: true,
    });
});

{% if item.in_stock %}

function itemAdjust(action) {
    launchModalForm("/stock/adjust/", 
        {
            data: {
                action: action,
                item: {{ item.id }},
            },
            reload: true,
            follow: true,
        }
    );
}

$("#stock-move").click(function() {
    itemAdjust("move");
});

$("#stock-count").click(function() {
    itemAdjust('count');
});

$('#stock-remove').click(function() {
    itemAdjust('take');
});

$('#stock-add').click(function() {
    itemAdjust('add');
});

{% endif %}

$("#stock-delete").click(function () {
    launchModalForm(
                     "{% url 'stock-item-delete' item.id %}",
                     {
                         redirect: "{% url 'part-stock' item.part.id %}"
                     });
});

{% endblock %}
